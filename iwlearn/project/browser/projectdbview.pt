<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="iwlearn.project">
<head>
    <metal:javascript_head fill-slot="javascript_head_slot">

 <!-- collective geo map -->

      <metal:use use-macro="context/@@collectivegeo-macros/openlayers" />

  <!-- collective geo map -->

    </metal:javascript_head>
</head>
<body>
    <div metal:fill-slot="main">
        <tal:main-macro metal:define-macro="main">
<!--[if lte IE 8]>
   <div style="color: red;">
    <big><strong>Microsoft Internet Explorer is not supported as this time</strong></big>
    <br />
    if you are using IE version 8 or older, you will not see the list of
    projects or the visualizations.
    <br />
    <a style="color: blue;" href="http://browsehappy.com/">Please upgrade your browser </a>
    </div>
    If you cannot upgrade your browser for any reason, you may want to switch off JavaScript
    to see the HTML only version of this website.

<![endif]-->
<!--[if IE]>
<script type="text/javascript" >
        /*<![CDATA[*/
        try {
            document.namespaces;
        } catch (e) {
            //
        }
        /*]]>*/
</script>
<![endif]-->



            <dl class="enableFormTabbing" tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime">
                <dt id="fieldsetlegend-map-projects">Map</dt>
                <dd id="fieldset-map-project">
                    <div id="projectsmap" style="height:200px; width: 900px">

<!-- Collective.geo map -->

        <metal:use use-macro="context/@@collectivegeo-macros/map-widget"  />
        <script type="text/javascript"
                src="++resource++geo.kml.javascripts/kml_openlayers.js"></script>
        <a id="projectkmlurl" href="projectdbkml_view">
        <img src=" http://www.google.com/earth/images/google_earth_feed.gif"
            alt="open in google earth" />
        Download KML</a>
        <script type="text/javascript" >
        /*<![CDATA[*/
    $(document).ready(function() {
        var map = cgmap.config['default-cgmap'].map;
        var kmls = map.getLayersByClass('OpenLayers.Layer.Vector');
        if (kmls.length > 0) {
            var kmlLayer = kmls[0];

            selectControl = new OpenLayers.Control.SelectFeature(
                    [kmlLayer],
                    {
                        clickout: true,
                        multiple: false,
                        hover: false
                    }
                );
            map.addControl(selectControl);
            selectControl.activate();
            kmlLayer.events.on({"featureselected": onFeatureSelect, "featureunselected": onFeatureUnselect});
        };

        function onPopupClose(evt) {
                map.removePopup(map.popups[0]);
        };


        function onFeatureSelect(event) {
                var message = '';
                var lt = String.fromCharCode(60);
                var gt = String.fromCharCode(62);
                var maxp = 12;
                var zoom_point = event.feature.geometry.getBounds().getCenterLonLat();
                var lon = zoom_point.lon;
                var lat = zoom_point.lat;
                function makeLink( title, description) {
                    var a = description.indexOf('href=');
                    var b = description.indexOf('"', a + 6);
                    var href = description.substring(a, b + 1) + ' ';
                    name = title.substring(0,32) + '...';
                    return lt + 'a ' + href + ' title="' + title + '" ' + gt + name + lt +'/a' + gt
                    }

                if (event.feature.cluster.length > maxp){
                        /*message =  lt +'div' + gt + event.feature.cluster.length + ' projects found';
                        message += lt + 'br /' + gt;
                        message += lt + 'a href="javascript:zoomToSelectedFeature('+ lon + ','+ lat +', 2)"' + gt;
                        message += 'zoom in for more details';
                        message += lt +'/a' + gt;*/
                        var currZoom = this.map.getZoom();
                        var newZoom = currZoom + 2;
                        this.map.setCenter(zoom_point, newZoom);

                }
                else if (event.feature.cluster.length > 1 && event.feature.cluster.length <= maxp){
                        message = lt +'div' + gt + event.feature.cluster.length + ' projects found: ';
                        message += lt + 'br /' + gt;
                        message += lt + 'a href="javascript:zoomToSelectedFeature('+ lon + ','+ lat +', 2)"' + gt;
                        message += 'zoom in for more details';
                        message += lt +'/a' + gt;
                        message += lt + 'ul' + gt;
                        for (var i=0; i<event.feature.cluster.length; ++i ) {
                            try {
                                message += lt + 'li' + gt;

                                    message += makeLink(event.feature.cluster[i].attributes['name'],event.feature.cluster[i].attributes['description']);

                                message += lt + '/li' + gt;
                            } catch(e) {
                                    //
                            };
                        }
                        message += lt + '/ul' + gt;
                } else if (event.feature.cluster.length == 1) {
                        message = lt +'div' + gt + makeLink(event.feature.cluster[0].attributes['name'], event.feature.cluster[0].attributes['description']);
                        message += event.feature.cluster[0].attributes['description'];
                }

                message += lt + '/div' + gt;
                if (event.feature.cluster.length <= maxp){
                    popup = new OpenLayers.Popup.FramedCloud("id", event.feature.geometry.bounds.getCenterLonLat(), null, message, null, true, onPopupClose);
                    event.popup = popup;
                    map.addPopup(popup);
                };

        };

        function onFeatureUnselect(event) {
            map.removePopup(map.popups[0]);
            event.popup.destroy();
            event.popup = null;
        };

});



    /* Zoom to Selected Feature from within Popup */

    function zoomToSelectedFeature(lon, lat, zoomfactor){
        var lonlat = new OpenLayers.LonLat(lon,lat);
        var map = cgmap.config['default-cgmap'].map;
        // Get Current Zoom
        currZoom = map.getZoom();
        // New Zoom
        newZoom = currZoom + zoomfactor;
        // Center and Zoom
        map.setCenter(lonlat, newZoom);
        // Remove Popups
        for (var i=0; i<map.popups.length; ++i){
            map.removePopup(map.popups[i]);
        };
    };

        /*]]>*/
        </script>

<!-- /Collective.geo map -->
                    </div>
                </dd>

                <dt id="fieldsetlegend-about-projects">About</dt>
                <dd id="fieldset-about-projects" class="documentDescription"
                    tal:content="here/Description">
                </dd>

                <dt id="fieldsetlegend-new-projects">New Projects</dt>
                <dd id="fieldset-new-projects" tal:define="results view/new_projects">
                  <ul>
                     <li tal:repeat="result results">
                        <i class="date" tal:content="python:toLocalizedTime(result.created)"></i><br/>
                      <a tal:attributes="href result/getURL" tal:content="result/Title|result/getId|Nothing"></a>
                    </li>
                  </ul>
                </dd>
                <dt id="fieldsetlegend-updated-projects">Recently Updated Projects</dt>
                <dd id="fieldset-updated-projects" tal:define="results view/updated_projects">
                  <ul>
                    <li tal:repeat="result results">
                        <i class="date" tal:content="python:toLocalizedTime(result.modified)"></i><br/>
                      <a tal:attributes="href result/getURL" tal:content="result/Title|result/getId|Nothing"></a>
                    </li>
                  </ul>
                </dd>
            </dl>
            <div class="visualClear">&nbsp;</div>
                <dl class="collapsible inline">
                    <dt class="collapsibleHeader">More... </dt>
                    <dd class="collapsibleContent">
                    <ul>
                        <li><a href="projectwebsites_view">Project Websites</a></li>
                        <li><a href="country_view.html">Projects by country (visualization)</a></li>
                    </ul>
                    </dd>
                </dl>

            <form id="projectsearchform" name="search" method="get" class="enableAutoFocus" action=".">
              <fieldset>
                <legend>Search for Projects</legend>
                <div class="field odd">
                    <label for="SearchableText">Search text</label>

                    <div class="formHelp">
                    For a simple text search, enter your search term
                    here. Multiple words may be found by combining
                    them with <strong>AND</strong> and <strong>OR</strong>.
                    The text in this field will be matched with
                    items' contents, title and description.
                    </div>

                    <input type="text" value="" size="25" name="SearchableText" id="SearchableText" />
                </div>

                <div class="field even">
                    <label for="Title">Title</label>
                    <div class="formHelp">
                    Return items matching this title.
                    </div>
                    <input type="text" size="25" name="Title" id="Title" />
                </div>


                <div class="field odd">
                    <label  for="getSubRegions">Region</label>
                    <div class="formHelp">
                    Return projects in this region
                    </div>
                        <select id="getSubRegions" name="getSubRegions">
                            <tal:loop tal:repeat="opt view/get_region">
                                <option value="Africa"
                                    tal:attributes="value opt/value;
                                        selected opt/selected;
                                        disabled opt/disabled;
                                        class opt/disabled;"
                                    tal:content="opt/name">Africa</option>
                            </tal:loop>
                        </select>
                </div>

                <div class="field even">
                    <label  for="getProject_type">Project type</label>
                    <div class="formHelp">
                    Return projects of this type
                    </div>
                        <select id="getProject_type" name="getProject_type">
                            <tal:loop tal:repeat="opt view/get_projecttype">
                                <option value="All"
                                    tal:attributes="value opt/value;
                                        selected opt/selected;
                                        disabled opt/disabled;
                                        class opt/disabled;"
                                    tal:content="opt/name">All</option>
                            </tal:loop>
                        </select>
                </div>

                <div class="field odd">
                    <label  for="getAgencies">Implementing agency</label>
                    <div class="formHelp">
                    Return projects this agency implements
                    </div>
                        <select id="getAgencies" name="getAgencies">
                            <tal:loop tal:repeat="opt view/get_agency">
                                <option value="All"
                                    tal:attributes="value opt/value;
                                        selected opt/selected;
                                        disabled opt/disabled;
                                        class opt/disabled;"
                                    tal:content="opt/name">All</option>
                            </tal:loop>
                        </select>
                </div>

                <div class="field even">
                    <label  for="getProject_status">Project status</label>
                    <div class="formHelp">
                    Return projects of this status
                    </div>
                        <select id="getProject_status" name="getProject_status">
                            <tal:loop tal:repeat="opt view/get_status">
                                <option value="All"
                                    tal:attributes="value opt/value;
                                        selected opt/selected;
                                        disabled opt/disabled;
                                        class opt/disabled;"
                                    tal:content="opt/name">All</option>
                            </tal:loop>
                        </select>
                </div>

                <div class="field odd">
                    <label  for="getBasin">Basin</label>
                    <div class="formHelp">
                    Return projects with this Basin
                    </div>
                        <select id="getBasin" name="getBasin">
                            <tal:loop tal:repeat="opt view/get_basin">
                                <option value="All"
                                    tal:attributes="value opt/value;
                                        selected opt/selected;
                                        disabled opt/disabled;
                                        class opt/disabled;"
                                    tal:content="opt/name">All</option>
                            </tal:loop>
                        </select>
                </div>


                <div class="formControls even">
                    <input type="submit" value="Search" name="submit"
                        class="context" />
                </div>
              </fieldset>
              <input type="hidden" value="-180,-90,180,90" name="bbox" id="inputbbox" />
            </form>

            <table id="flexiprojects" style="display:none"></table>

<script type="text/javascript" tal:content="structure view/get_js">

 $(document).ready(function() {
   $("#projectsearchform").find("select").each(function(i) {
     $(this).change(function( objEvent ){
         $('#flexiprojects').flexOptions({newp: 1}).flexReload();
        }) ;
   });
 });



    $("#flexiprojects").flexigrid
            (
            {
            url: '@@flexijson_view',
            dataType: 'json',
            colModel : [
                {display: 'Title', name : 'Title', width : 220, sortable : true, align: 'left'},
                {display: 'Project type', name : 'getProject_type', width : 100, sortable : true, align: 'left'},
                {display: 'Implementing agencies', name : 'getAgencies', width : 220, sortable : true, align: 'left'},
                {display: 'Region', name : 'getSubRegions', width : 200, sortable : true, align: 'left'},
                {display: 'Status', name : 'getProject_status', width : 100, sortable : true, align: 'left'},
                {display: 'URL', name : 'getRemoteUrl', width : 100, sortable : false, align: 'left', hide: true}
                ],
            sortname: "Title",
            sortorder: "asc",
            usepager: true,
            title: 'Projects',
            useRp: true,
            rp: 15,
            showTableToggleBtn: true,
            width: 900,
            onSubmit: addFormData,
            height: 200
            }
            );


    /*This function adds paramaters to the post of flexigrid.
    You can add a verification as well by return to false if
    you don't want flexigrid to submit function addFormData() */
    function addFormData() {
        /*passing a form object to serializeArray will get the valid data
        from all the objects, but, if the you pass a non-form object,
        you have to specify the input elements that the data will come from */
        var dt = $('#projectsearchform').serializeArray();
        $("#flexiprojects").flexOptions({params: dt});
        // refresh map
        var qs = '?';
        var params = {};
        jQuery.each(dt, function(i, field){
            qs = qs + field.name + '=' + field.value + "&";
            params[field.name] = field.value;
        });
        var map = cgmap.config['default-cgmap'].map;
        var kmls = map.getLayersByClass('OpenLayers.Layer.GML');
        layer = kmls[0];
        layer.setVisibility(false);
        layer.loaded = false;
        layer.setUrl('http://localhost:8080/iwlearn/iw-projects/@@projectdbkml_view' + qs);
        layer.refresh({ force: true, params: params });
        layer.setVisibility(true);

        return true;
    }


$('#projectsearchform').submit
(
    function ()
        {
            $('#flexiprojects').flexOptions({newp: 1}).flexReload();
            return false;
        }
);


</script>


            <noscript tal:define="search_results view/search_results" tal:condition="search_results">
              <table  tal:define="results search_results/results;
                         Batch python:modules['Products.CMFPlone'].Batch;
                         b_size search_results/size;
                         b_start search_results/start;
                         searchterm view/search_term"
                         class='listing'>
                <caption tal:condition="not: results">
                  <strong i18n:translate="description_no_results_found">
                    No results were found.
                  </strong>
                </caption>
                <caption tal:condition="results">
                   <strong i18n:translate="batch_x_items_matching_your_criteria">
                        <span i18n:name="number" tal:content="python:len(results)">234</span> items matching your criteria.
                   </strong>
                </caption>
                <thead>
                    <tr>
                      <th>Title</th>
                      <th>Status</th>
                      <th>Project type</th>
                      <th>Lead agency</th>
                      <th>Region</th>
                      <th>Status</th>
                    </tr>
                </thead>
                <tfoot tal:define="batch python:Batch(results, b_size, int(b_start), orphan=1);">
                    <tr> <td colspan="5"> <div metal:use-macro="here/batch_macros/macros/navigation" /> </td></tr>
                </tfoot>
                <tbody tal:condition="results" tal:define="batch python:Batch(results, b_size, int(b_start), orphan=1);">
                  <tal:loop tal:repeat="result batch">
                      <tr tal:define="oddrow repeat/result/odd;"
                            tal:attributes="class python:oddrow and 'even' or 'odd'">
                          <td> <a tal:attributes="href result/getURL;" tal:content="result/Title">title</a> </td>
                          <td tal:content="result/getProject_status">status</td>
                          <td tal:content="result/getProject_type"></td>
                          <td> <span tal:content="python:', '.join(result.getAgencies)" tal:on-error="nothing" /></td>
                          <td> <span tal:content="python:', '.join(result.getSubRegions)" tal:on-error="nothing" /></td>
                          <td tal:content="result/getProject_status"></td>
                      </tr>
                  </tal:loop>
                </tbody>
              </table>
            </noscript>
        </tal:main-macro>
    </div>
</body>
</html>
